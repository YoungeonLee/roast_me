{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Game Room</title>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        var MESSAGE;
        class Player extends React.Component{
            render(){
                const style = {
                    float: 'right'
                }
                if (this.props.state === 1){
                    var imgSrc = "{% static 'game/logo.png' %}"
                } else if (this.props.state === 2){
                    var imgSrc = "{% static 'game/gavel.png' %}"
                } else{
                    var imgSrc = ""
                }
        
                return(
                    <li className='list-group-item'>
                        <span> name {this.props.name} </span>
                        <span> state {this.props.state} </span>
                        <span> {this.props.admin.toString()} </span>
                        <img src={imgSrc}/>
                        <span style={style}> {this.props.score}</span>
                    </li>
                );
            }
        }
        class Scoreboard extends React.Component{
            /*
            constructor(props){
                super(props);
                this.state = {
                    loading: true
                };
            }*/
            render(){
                const data = this.props.players;
                var items = Object.keys(data).map(key => 
                    <Player key={key} name={key} state={data[key].state} score={data[key].score} admin={data[key].admin}/>
                );
                return(
                    <ul className='list-group'>
                        {items}
                    </ul>
                );
            }

            update = () => {
                this.setState(state => ({
                    loading: false
                }))
            }
        }

        class StartButton extends React.Component{
            render(){
                if (this.props.player.button && this.props.game.state !== 3){
                    var buttonStyle = {display: "block"};
                    if (this.props.game.state === 0){
                        var text = "start";
                        var func = startGame;
                    } else if (this.props.game.state === 4){
                        var text = "new game";
                        var func = startGame;
                    } else {
                        var text = "skip";
                        var func = skip;
                    }
                } else {
                    var buttonStyle = {display: "none"};
                    var text = "";
                    var func = null
                }
                return(
                    <button onClick={func} style={buttonStyle}> {text} </button>
                );
            }
        }
        class Roastee extends React.Component{

            componentDidUpdate(prevProps, prevState) {
                if (this.props.game.state !== 0){
                    var img = images[this.props.game.roastee.username];
                    var imageContainer = document.getElementById("roastImage");
                    imageContainer.replaceChild(img, imageContainer.childNodes[0]);
                }
            }

            render(){
                const imgStyle = {
                    maxWidth: "100%",
                    maxHeight: "100%"
                }
                if (this.props.game.winner !== ""){
                    return(
                        <div> 
                            {this.props.game.winner} won the game!
                        </div>
                    )
                } else if (this.props.game.state !== 0){
                    return(
                        <div className="card">
                            <div id="roastImage">
                                <img/>
                            </div>
                            <div className="card-body">
                                <h5 className="card-title">{this.props.game.roastee.username}</h5>
                                <p className="card-text">{this.props.game.roastee.description}</p>
                            </div>
                        </div>
                    );
                } else {
                    return(
                        <div>Get Ready to Roast Each Other!</div>
                    );
                }
            }
        }

        class Roast extends React.Component{
            constructor(props) {
                super(props);
                // This binding is necessary to make `this` work in the callback
                this.handleClick = this.handleClick.bind(this);
            }

            handleClick(){
                const roastContent = document.getElementById("roastContent").value;
                document.getElementById("roastContent").value = "";
                gameSocket.send(JSON.stringify({"action": "roast", "message": roastContent}));
            }
            render(){
                if (this.props.player.state === 0 && this.props.player.submitted === false && this.props.game.state === 1){
                    var inputStyle = {display: "block"}
                } else {
                    var inputStyle = {display: "none"}
                }
                return(
                    <div style={inputStyle} id="roastButton">
                        <div className="input-group">
                            <textarea id = "roastContent" className="form-control" aria-label="With textarea"></textarea>
                            <div className="input-group-append">
                                <button onClick={this.handleClick} className="input-group-text">Roast</button>
                            </div>
                        </div>
                    </div>
                )
            }
        }
        class Selection extends React.Component{
            render(){
                if (this.props.game.state === 3){
                    var cardStyle = {display: "block"};
                } else{
                    var cardStyle = {display: "none"};
                }

                return(
                    <div className="card text-white bg-danger mb-3" style={cardStyle}>
                        <div className="card-header">{this.props.game.roundWinner}</div>
                        <div className="card-body">
                            <p className="card-text">{this.props.game.selectedRoast}</p>
                        </div>
                    </div>
                )
            }
        }
        class JudgeButton extends React.Component{
            constructor(props) {
                super(props);
                // This binding is necessary to make `this` work in the callback
                this.handleClick = this.handleClick.bind(this);
            }
            
            handleClick(){
                    if (this.props.player.state === 2){
                        document.getElementById("judge").style.display = "none"
                        gameSocket.send(JSON.stringify({"action":"judge", "player": this.props.username}));
                    }
                }

            render(){
                //var buttonStyle = {maxWidth: "18rem;"}
                if (this.props.player.state === 2){
                    var classStyle = "card btn-outline-danger mb-3";
                    var textStyle = "card-body";
                } else{
                    var classStyle = "card mb-3";
                    var textStyle = "card-body text-danger";
                }

                return(
                    <div className={classStyle} onClick={this.handleClick}>
                        <div className={textStyle}>
                            <p className="card-text">{this.props.content}</p>
                        </div>
                    </div>
                )
            }
        }

        class Judge extends React.Component{
            render(){
                if (this.props.game.state === 2){
                    var judgeStyle = {display: "block"}
                } else {
                    var judgeStyle = {display: "none"};
                }
                const data = this.props.game.roast;
                var items = Object.keys(data).map(key => 
                    <JudgeButton key={key} username={key} content={data[key]} player={this.props.player}/>
                )
                return(
                    <div style={judgeStyle} id="judge">
                        {items}
                    </div>
                )
            }
        }

        class Timer extends React.Component{
            constructor(props) {
                super(props);
                this.state = {time: props.game.timer - Math.round((new Date() - new Date(props.game.time))/1000 )};
            }
            componentDidMount() {
                this.interval = setInterval(() => {
                    let t = this.props.game.timer - Math.round((new Date() - new Date(this.props.game.time))/1000 );
                    if (t >= 0){
                        this.setState({time: t});
                    } else {
                        if (this.props.player.admin && (this.props.game.state === 1 || this.props.game.state === 2)){
                            skip();
                        }
                    }
                }, 1000);
            }

            componentWillUnmount() {
                clearInterval(this.interval);
            }

            componentDidUpdate(prevProps, prevState) {
                if (prevProps.game.state !== this.props.game.state){
                    this.setState({time: this.props.game.timer - Math.round((new Date() - new Date(this.props.game.time))/1000 )})
                }
            }

            render(){
                if (this.props.game.state === 1 || this.props.game.state === 2){
                    var timerStyle = {display: "block"};
                } else {
                    var timerStyle = {display: "none"};
                }
                return(
                    <div style={timerStyle}>{this.state.time}</div>
                )
            }
        }

        class App extends React.Component{
            render(){
                return(
                    <div className="container-fluid">
                        <div className="row">
                            <div className="col">
                                <div className="row">
                                    <div className = "col">
                                        <div>{this.props.game.state}</div>
                                        <Timer game = {this.props.game} player = {this.props.player}/>
                                        <Scoreboard players={this.props.game.players}/>
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col">
                                        <StartButton player={this.props.player} game = {this.props.game}/>
                                    </div>
                                </div>
                            </div>
                            <div className="col">
                                <div className="row">
                                    <div className="col">
                                        <Roastee game ={this.props.game}/>
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col">
                                        <Judge player={this.props.player} game = {this.props.game}/>
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col">
                                        <Selection player={this.props.player} game = {this.props.game}/>
                                    </div>
                                </div>
                                <div className="row">
                                    <div className="col">
                                        <Roast player={this.props.player} game = {this.props.game}/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        }
 
        // websocket comp
        const roomName = "{{room_name}}";

        const gameSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/game/'
            + roomName
            + '/'
        );

        function skip(){
            gameSocket.send(JSON.stringify({'action': "skip"}));
        }
        function startGame(){
            gameSocket.send(JSON.stringify({'action': "startGame"}));
        }
        
        var images = {}

        gameSocket.onmessage = function(e) {
            MESSAGE = e;
            console.log(e);
            console.log(e.size);
            const data = JSON.parse(e.data);
            console.log(data);
            var player;
            for (player in data.game.players){
                if (!(player in images)){
                    var image = new Image();
                    image.src = data.game.players[player].image;
                    image.className = "card-img-top";
                    images[player] = image;
                    console.log("new image 1");
                } 
                /* do this after having a server name
                else {
                    if (images[player].src !== data.game.players[player].image){
                        var image = new Image();
                        image.src = data.game.players[player].image;
                        image.className = "card-img-top";
                        images[player] = image;
                        console.log("new image 2");
                    }
                }
                */
            }
            ReactDOM.render(<App game={data.game} player={data.player}/>, document.getElementById("app"));        
        };

        gameSocket.onclose = function(e) {
            alert('Websocket closed unexpectedly');
        };
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
</body>
</html>